<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام فريق الاختبار الآمن</title>
    <style>
        /* جميع الأنماط السابقة تبقى كما هي */
        
        /* إضافة أنماط جديدة للأمان */
        .security-badge {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
        }
        
        .admin-panel {
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border: 1px solid #dc2626;
        }
        
        .security-alert {
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0% { border-color: #dc2626; }
            50% { border-color: #f87171; }
            100% { border-color: #dc2626; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- جميع عناصر الواجهة السابقة تبقى كما هي -->
        
        <!-- إضافة لوحة التحكم الآمنة -->
        <div id="secureAdminPanel" class="admin-panel" style="display: none;">
            <h2 style="color: #f87171;">👑 لوحة التحكم الآمنة</h2>
            <div class="form-group">
                <button class="btn" onclick="showUserManagement()">إدارة المستخدمين</button>
                <button class="btn" onclick="showSecurityLogs()">سجل الأمان</button>
                <button class="btn logout-btn" onclick="lockAdminPanel()">قفل اللوحة</button>
            </div>
            
            <div id="userManagementSection" style="display: none;">
                <h3>إدارة المستخدمين</h3>
                <div id="usersList"></div>
            </div>
            
            <div id="securityLogsSection" style="display: none;">
                <h3>سجل الأمان</h3>
                <div class="admin-log" id="securityLogs"></div>
            </div>
        </div>
        
        <div class="security-badge" id="securityBadge">🔒 وضع آمن: غير نشط</div>
    </div>

    <script>
        // ===== النظام الأمني المدمج =====
        let securityToken = '';
        let failedLoginAttempts = {};
        const SECURITY_CONFIG = {
            MAX_LOGIN_ATTEMPTS: 3,
            LOCKOUT_TIME: 5 * 60 * 1000 // 5 دقائق
        };
        
        // توليد توكن أمان
        function generateSecurityToken() {
            securityToken = Math.random().toString(36).substring(2, 15) + 
                            Math.random().toString(36).substring(2, 15);
            return securityToken;
        }
        
        // تسجيل أحداث الأمان
        function logSecurityEvent(event) {
            const timestamp = new Date().toLocaleString('ar-SA');
            const logEntry = `[${timestamp}] ${event}`;
            const logElement = document.createElement('div');
            logElement.textContent = logEntry;
            
            if (document.getElementById('securityLogs')) {
                document.getElementById('securityLogs').prepend(logElement);
            }
            
            console.log('%cSECURITY: ' + logEntry, 'color: red;');
        }
        
        // التحقق من حالة الحماية
        function checkSecurityStatus() {
            const badge = document.getElementById('securityBadge');
            if (currentUser && secureUsers[currentUser]?.role === 'admin') {
                badge.textContent = '🔐 وضع آمن: نشط (مسؤول)';
                badge.style.color = '#4ade80';
            } else if (currentUser) {
                badge.textContent = '🔒 وضع آمن: نشط';
                badge.style.color = '#60a5fa';
            } else {
                badge.textContent = '🔓 وضع آمن: غير نشط';
                badge.style.color = '#f87171';
            }
        }
        
        // ===== التكامل مع النظام الأصلي =====
        
        // تعديل دالة تسجيل الدخول
        async function login() {
            const username = sanitizeInput(document.getElementById('username').value);
            const password = document.getElementById('password').value;
            
            // التحقق من محاولات الدخول الفاشلة
            if (failedLoginAttempts[username] && 
                failedLoginAttempts[username].count >= SECURITY_CONFIG.MAX_LOGIN_ATTEMPTS &&
                Date.now() - failedLoginAttempts[username].time < SECURITY_CONFIG.LOCKOUT_TIME) {
                
                const remainingTime = Math.ceil(
                    (SECURITY_CONFIG.LOCKOUT_TIME - (Date.now() - failedLoginAttempts[username].time)) / 60000
                );
                
                showNotification(`تم تجاوز عدد المحاولات المسموحة. يرجى المحاولة بعد ${remainingTime} دقائق`, 'error');
                logSecurityEvent(`محاولة دخول محظورة للمستخدم: ${username}`);
                return;
            }
            
            if (!username || !password) {
                showNotification('يرجى إدخال اسم المستخدم وكلمة المرور', 'error');
                return;
            }
            
            // التحقق من المستخدم
            if (users[username]) {
                // في نظام الإنتاج الحقيقي، يجب استخدام التجزئة
                if (users[username] === password) {
                    currentUser = username;
                    failedLoginAttempts[username] = { count: 0, time: 0 };
                    
                    // توليد توكن جلسة آمن
                    generateSecurityToken();
                    logSecurityEvent(`تسجيل دخول ناجح للمستخدم: ${username}`);
                    
                    // عرض الواجهة المناسبة
                    if (username === 'admin') {
                        document.getElementById('secureAdminPanel').style.display = 'block';
                        logSecurityEvent('فتح لوحة الإدارة');
                    }
                    
                    showNotification('تم تسجيل الدخول بنجاح!', 'success');
                    checkSecurityStatus();
                    
                } else {
                    // زيادة عدد المحاولات الفاشلة
                    if (!failedLoginAttempts[username]) {
                        failedLoginAttempts[username] = { count: 0, time: 0 };
                    }
                    failedLoginAttempts[username].count++;
                    failedLoginAttempts[username].time = Date.now();
                    
                    showNotification('اسم المستخدم أو كلمة المرور غير صحيحة', 'error');
                    logSecurityEvent(`محاولة دخول فاشلة للمستخدم: ${username}`);
                }
            } else {
                showNotification('اسم المستخدم غير موجود', 'error');
            }
        }
        
        // تعديل دالة تسجيل الخروج
        function logout() {
            logSecurityEvent(`تسجيل خروج للمستخدم: ${currentUser}`);
            currentUser = '';
            securityToken = '';
            checkSecurityStatus();
            // ... باقي الكود الأصلي ...
        }
        
        // دالة تنظيف المدخلات
        function sanitizeInput(input) {
            return input.replace(/</g, "&lt;").replace(/>/g, "&gt;");
        }
        
        // ===== وظائف لوحة الإدارة =====
        
        function showUserManagement() {
            if (currentUser !== 'admin') return;
            
            document.getElementById('userManagementSection').style.display = 'block';
            document.getElementById('securityLogsSection').style.display = 'none';
            
            // عرض قائمة المستخدمين
            let usersHTML = '';
            for (const [username, password] of Object.entries(users)) {
                usersHTML += `
                    <div class="member-item">
                        <span class="status ${username === 'admin' ? 'admin' : 'online'}">
                            ${username === 'admin' ? 'مسؤول' : 'مستخدم'}
                        </span>
                        ${username} - آخر نشاط: ${new Date().toLocaleString('ar-SA')}
                    </div>
                `;
            }
            document.getElementById('usersList').innerHTML = usersHTML;
        }
        
        function showSecurityLogs() {
            if (currentUser !== 'admin') return;
            
            document.getElementById('userManagementSection').style.display = 'none';
            document.getElementById('securityLogsSection').style.display = 'block';
        }
        
        function lockAdminPanel() {
            document.getElementById('secureAdminPanel').style.display = 'none';
            logSecurityEvent('إغلاق لوحة الإدارة');
        }
        
        // تحديث حالة الأمان عند تحميل الصفحة
        window.addEventListener('load', checkSecurityStatus);
    </script>
</body>
</html>
